# 노션 웹훅 연동 설계서
## VisionMakers 상담 관리 시스템 - 노션 알림 통합

### 📋 개요

상담 신청이 완료되거나 중요한 상담 관련 이벤트가 발생할 때, 자동으로 노션 워크스페이스에 메시지를 전송하는 시스템을 구축합니다.

### 🎯 목적

1. **실시간 알림**: 새로운 상담 요청 시 즉시 노션 채널에 알림
2. **상담 정보 공유**: 상담 상세 내용을 팀원들과 실시간 공유
3. **업무 효율성**: 노션을 통한 중앙집중식 상담 관리 및 추적
4. **자동화**: 수동 복사/붙여넣기 없이 자동으로 정보 동기화

### 🏗️ 시스템 아키텍처

```
상담 신청/업데이트 → 웹훅 트리거 → 노션 API → 노션 페이지/데이터베이스 생성
```

#### 주요 컴포넌트

1. **노션 웹훅 서비스** (`utils/notionWebhook.ts`)
2. **노션 페이지 템플릿** (상담 정보 포맷팅)
3. **이벤트 트리거** (기존 알림 시스템 확장)
4. **에러 처리 및 재시도 로직**

### 📊 노션 연동 방식

#### 옵션 1: 노션 데이터베이스 연동 (권장)
- 새로운 상담을 노션 데이터베이스에 행(Row)으로 추가
- 구조화된 데이터로 필터링/정렬 가능
- 템플릿 기반 일관된 포맷

#### 옵션 2: 노션 페이지 생성
- 각 상담마다 개별 페이지 생성
- 더 자유로운 포맷팅 가능
- 긴 내용이나 첨부파일 지원

### 🔧 기술 스택

- **노션 API**: `@notionhq/client`
- **인증**: 노션 Integration Token
- **트리거**: 기존 `adminNotificationTrigger` 시스템 확장
- **템플릿**: 마크다운 기반 메시지 포맷팅

### 📋 상담 정보 필드 매핑

#### 기본 정보
- **상담 번호**: `consultation_number`
- **고객명**: `contact_name`
- **회사명**: `contact_company`
- **이메일**: `contact_email`
- **전화번호**: `contact_phone`
- **상담 유형**: `type` (가이드/자유)

#### 프로젝트 정보
- **서비스 타입**: `service_type`
- **프로젝트 규모**: `project_size`
- **예산 범위**: `budget`
- **일정**: `timeline`
- **주요 기능**: `important_features`
- **추가 요청사항**: `additional_requests`
- **프로젝트 설명**: `project_description`

#### 메타 정보
- **접수 시간**: `created_at`
- **상태**: `status`
- **우선순위**: `priority`
- **담당자**: `assigned_to`
- **유입 경로**: `utm_source`

### 🎨 노션 메시지 템플릿

#### 새 상담 요청 알림
```markdown
🆕 새로운 상담 요청 접수

**📋 기본 정보**
• 상담번호: [consultation_number]
• 고객명: [contact_name]
• 회사: [contact_company]
• 이메일: [contact_email]
• 전화: [contact_phone]
• 접수시간: [created_at]

**💼 프로젝트 정보**
• 서비스: [service_type]
• 규모: [project_size]
• 예산: [budget]
• 일정: [timeline]

**📝 상세 내용**
[project_description | additional_requests]

**🔗 관리**
• 상태: [status]
• 우선순위: [priority]
• 관리 링크: [admin_url]

**📊 유입 정보**
• 소스: [utm_source]
• 매체: [utm_medium]
• 캠페인: [utm_campaign]
```

#### 상담 상태 변경 알림
```markdown
🔄 상담 상태 업데이트

**상담번호**: [consultation_number]
**고객**: [contact_name] ([contact_company])
**변경사항**: [from_status] → [to_status]
**변경자**: [actor_name]
**변경시간**: [updated_at]

[관리 링크]
```

### 🔐 보안 및 인증

#### 노션 Integration 설정
1. **Notion Developer Portal**에서 새 Integration 생성
2. **Internal Integration** 선택 (보안상 권장)
3. **기본 권한** 설정:
   - Read content
   - Insert content
   - Update content

#### 환경 변수
```bash
NOTION_API_KEY=secret_xxxxxxxxxxxx
NOTION_DATABASE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
NOTION_WORKSPACE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

### 📊 노션 데이터베이스 스키마

#### 상담 관리 데이터베이스 구조
```json
{
  "properties": {
    "상담번호": {
      "type": "title"
    },
    "고객명": {
      "type": "rich_text"
    },
    "회사명": {
      "type": "rich_text"
    },
    "이메일": {
      "type": "email"
    },
    "전화번호": {
      "type": "phone_number"
    },
    "상담유형": {
      "type": "select",
      "options": [
        {"name": "가이드 상담", "color": "blue"},
        {"name": "자유 상담", "color": "green"}
      ]
    },
    "서비스타입": {
      "type": "select",
      "options": [
        {"name": "웹사이트 제작", "color": "purple"},
        {"name": "모바일 앱", "color": "pink"},
        {"name": "데스크톱 앱", "color": "orange"},
        {"name": "AI/ML", "color": "red"},
        {"name": "컨설팅", "color": "gray"}
      ]
    },
    "상태": {
      "type": "select",
      "options": [
        {"name": "대기중", "color": "yellow"},
        {"name": "진행중", "color": "blue"},
        {"name": "완료", "color": "green"},
        {"name": "취소", "color": "red"}
      ]
    },
    "우선순위": {
      "type": "select",
      "options": [
        {"name": "긴급", "color": "red"},
        {"name": "높음", "color": "orange"},
        {"name": "보통", "color": "yellow"},
        {"name": "낮음", "color": "gray"}
      ]
    },
    "예산범위": {
      "type": "select",
      "options": [
        {"name": "100만원 미만", "color": "gray"},
        {"name": "100-300만원", "color": "brown"},
        {"name": "300-500만원", "color": "orange"},
        {"name": "500-1000만원", "color": "yellow"},
        {"name": "1000만원 이상", "color": "green"}
      ]
    },
    "접수일시": {
      "type": "created_time"
    },
    "최종수정": {
      "type": "last_edited_time"
    },
    "담당자": {
      "type": "people"
    },
    "유입경로": {
      "type": "rich_text"
    },
    "관리링크": {
      "type": "url"
    },
    "프로젝트설명": {
      "type": "rich_text"
    }
  }
}
```

### 🔄 이벤트 트리거 포인트

#### 1. 새 상담 요청 (consultation-submit.ts)
```typescript
// 상담 생성 후
await triggerNotionWebhook({
  event: 'consultation_created',
  consultationId: consultation.id,
  priority: 'normal'
});
```

#### 2. 상담 상태 변경 (consultations/[id].ts)
```typescript
// 상태 변경 후
await triggerNotionWebhook({
  event: 'consultation_status_changed',
  consultationId: id,
  changes: {
    status: { from: oldStatus, to: newStatus }
  }
});
```

#### 3. 담당자 배정
```typescript
// 담당자 배정 후
await triggerNotionWebhook({
  event: 'consultation_assigned',
  consultationId: id,
  assignedTo: newAssignee
});
```

### 🛠️ 구현 계획

#### Phase 1: 기본 연동 (1-2일)
- [x] 노션 API 클라이언트 설정
- [x] 기본 웹훅 서비스 구현
- [x] 새 상담 요청 시 노션 알림

#### Phase 2: 고급 기능 (2-3일)
- [ ] 상담 상태 변경 알림
- [ ] 담당자 배정 알림
- [ ] 에러 처리 및 재시도 로직

#### Phase 3: 최적화 (1일)
- [ ] 메시지 템플릿 개선
- [ ] 배치 처리 및 성능 최적화
- [ ] 모니터링 및 로깅

### 📊 성능 고려사항

#### API 호출 제한
- **노션 API 제한**: 초당 3회 요청
- **배치 처리**: 여러 이벤트를 묶어서 처리
- **큐 시스템**: 대량 요청 시 순차 처리

#### 에러 처리
- **재시도 로직**: 지수적 백오프
- **실패 알림**: 슬랙/이메일로 에러 통지
- **로그 관리**: 상세한 에러 로깅

#### 보안
- **API 키 보안**: 환경 변수로 관리
- **권한 최소화**: 필요한 권한만 부여
- **감사 로그**: 모든 API 호출 기록

### 🧪 테스트 계획

#### 단위 테스트
- [ ] 노션 API 연동 테스트
- [ ] 메시지 포맷팅 테스트
- [ ] 에러 처리 테스트

#### 통합 테스트
- [ ] 전체 플로우 테스트
- [ ] 실제 노션 워크스페이스 연동 테스트
- [ ] 성능 테스트

#### 모니터링
- [ ] API 호출 성공률
- [ ] 응답 시간 모니터링
- [ ] 에러율 추적

### 📝 사용자 가이드

#### 노션 워크스페이스 설정
1. 노션에서 새 데이터베이스 생성
2. 위의 스키마에 따라 프로퍼티 설정
3. Integration을 데이터베이스에 연결
4. 환경 변수에 데이터베이스 ID 설정

#### 알림 설정
1. 알림 받을 채널/페이지 지정
2. 알림 빈도 및 조건 설정
3. 메시지 템플릿 커스터마이징

#### 문제 해결
- **연동 실패**: API 키 및 권한 확인
- **메시지 누락**: 에러 로그 확인
- **포맷 오류**: 템플릿 구문 검증

### 🔮 향후 확장 계획

#### 고급 기능
- **상담 진행률 트래킹**: 단계별 진행 상황
- **자동 할당**: AI 기반 담당자 추천
- **고객 피드백**: 상담 만족도 수집

#### 다른 도구 연동
- **슬랙 연동**: 팀 커뮤니케이션
- **구글 캘린더**: 상담 일정 관리
- **CRM 연동**: 고객 관계 관리

이 설계서를 바탕으로 단계적으로 구현하여 효율적인 상담 관리 시스템을 완성할 수 있습니다.