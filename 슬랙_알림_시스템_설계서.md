# 슬랙 알림 시스템 설계서 📧

## 📋 프로젝트 개요

### 목적
상담신청이 완료될 때마다 슬랙 채널로 실시간 알림을 발송하여 빠른 대응과 고객 서비스 향상을 도모

### 범위
- 가이드 상담신청 완료 시 슬랙 알림
- 자유 상담신청 완료 시 슬랙 알림
- 관리자 페이지에서 수동 알림 발송 기능

---

## 🏗️ 시스템 아키텍처

### 전체 플로우
```
사용자 상담신청 → API 엔드포인트 → 데이터베이스 저장 → 슬랙 웹훅 호출 → 슬랙 채널 알림
```

### 구성 요소
1. **Frontend**: 상담신청 폼
2. **Backend API**: 상담 처리 및 슬랙 알림 트리거
3. **Slack Webhook**: 메시지 발송 인터페이스
4. **Database**: 상담 데이터 및 알림 로그 저장

---

## 🔧 기술 스택

### 필요한 라이브러리
```json
{
  "@slack/webhook": "^7.0.2",
  "node-cron": "^3.0.3"
}
```

### 환경 변수
```env
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
SLACK_CHANNEL=#상담신청
SLACK_USERNAME=상담알림봇
```

---

## 📁 파일 구조

```
utils/
├── slackNotification.ts      # 슬랙 알림 유틸리티
├── notificationTemplates.ts  # 메시지 템플릿
└── notificationQueue.ts      # 알림 큐 관리

pages/api/
├── consultation-submit.ts    # 상담신청 API (기존)
└── admin/
    └── send-notification.ts  # 수동 알림 발송 API

types/
└── slack.ts                 # 슬랙 관련 타입 정의
```

---

## 🎯 핵심 기능

### 1. 슬랙 알림 유틸리티 (`utils/slackNotification.ts`)

```typescript
interface SlackNotificationData {
  consultationType: 'guided' | 'free';
  clientName: string;
  email: string;
  phone: string;
  company?: string;
  projectType?: string;
  budget?: string;
  message?: string;
  createdAt: string;
  consultationNumber: string;
}

interface SlackMessage {
  text: string;
  blocks: SlackBlock[];
  username?: string;
  channel?: string;
  icon_emoji?: string;
}

// 메인 알림 함수
export async function sendSlackNotification(data: SlackNotificationData): Promise<boolean>

// 에러 알림 함수
export async function sendErrorNotification(error: string, context: string): Promise<void>

// 일일 요약 알림 함수
export async function sendDailySummary(summaryData: DailySummaryData): Promise<void>
```

### 2. 메시지 템플릿 (`utils/notificationTemplates.ts`)

```typescript
// 가이드 상담 템플릿
export function createGuidedConsultationMessage(data: SlackNotificationData): SlackMessage

// 자유 상담 템플릿
export function createFreeConsultationMessage(data: SlackNotificationData): SlackMessage

// 긴급 상담 템플릿
export function createUrgentConsultationMessage(data: SlackNotificationData): SlackMessage

// 일일 요약 템플릿
export function createDailySummaryMessage(data: DailySummaryData): SlackMessage
```

### 3. 알림 큐 관리 (`utils/notificationQueue.ts`)

```typescript
interface NotificationJob {
  id: string;
  type: 'consultation' | 'error' | 'summary';
  data: any;
  retryCount: number;
  scheduledAt: Date;
  status: 'pending' | 'processing' | 'completed' | 'failed';
}

// 큐에 알림 작업 추가
export async function addNotificationToQueue(job: Omit<NotificationJob, 'id' | 'retryCount' | 'status'>): Promise<void>

// 큐 처리
export async function processNotificationQueue(): Promise<void>

// 실패한 알림 재시도
export async function retryFailedNotifications(): Promise<void>
```

---

## 🔔 슬랙 메시지 디자인

### 가이드 상담 메시지 예시
```json
{
  "text": "🆕 새로운 가이드 상담신청이 접수되었습니다!",
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "🆕 새로운 가이드 상담신청"
      }
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*고객명:*\n홍길동"
        },
        {
          "type": "mrkdwn",
          "text": "*연락처:*\n010-1234-5678"
        },
        {
          "type": "mrkdwn",
          "text": "*이메일:*\nhong@example.com"
        },
        {
          "type": "mrkdwn",
          "text": "*회사명:*\n(주)테스트컴퍼니"
        }
      ]
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*프로젝트 유형:*\n웹사이트 제작"
        },
        {
          "type": "mrkdwn",
          "text": "*예산:*\n300-500만원"
        },
        {
          "type": "mrkdwn",
          "text": "*일정:*\n1-3개월"
        },
        {
          "type": "mrkdwn",
          "text": "*상담번호:*\nGU-2024-001"
        }
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*추가 요청사항:*\n반응형 웹사이트로 제작을 원합니다."
      }
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "관리자 페이지에서 확인"
          },
          "url": "https://yourdomain.com/admin/consultations/GU-2024-001",
          "style": "primary"
        },
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "고객에게 연락하기"
          },
          "url": "tel:010-1234-5678"
        }
      ]
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "📅 접수시간: 2024-09-21 17:30:45 | 🌐 IP: 192.168.1.1"
        }
      ]
    }
  ]
}
```

---

## 🔌 API 통합

### 1. 기존 상담신청 API 수정 (`pages/api/consultation-submit.ts`)

```typescript
// 기존 로직 + 슬랙 알림 추가
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    // 1. 상담 데이터 검증
    const validatedData = validateConsultationData(req.body);

    // 2. 데이터베이스 저장
    const consultation = await saveConsultation(validatedData);

    // 3. 슬랙 알림 발송 (비동기)
    addNotificationToQueue({
      type: 'consultation',
      data: {
        ...consultation,
        consultationType: req.body.consultationType
      },
      scheduledAt: new Date()
    }).catch(error => {
      console.error('슬랙 알림 큐 추가 실패:', error);
    });

    // 4. 클라이언트 응답
    res.status(200).json({
      success: true,
      consultationNumber: consultation.consultationNumber
    });

  } catch (error) {
    // 에러 알림도 슬랙으로 발송
    sendErrorNotification(error.message, 'consultation-submit').catch(console.error);
    res.status(500).json({ success: false, error: error.message });
  }
}
```

### 2. 수동 알림 발송 API (`pages/api/admin/send-notification.ts`)

```typescript
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  // 관리자 인증 확인
  if (!isAdminAuthenticated(req)) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  const { consultationId, type } = req.body;

  try {
    // 상담 정보 조회
    const consultation = await getConsultationById(consultationId);

    // 슬랙 알림 발송
    const success = await sendSlackNotification({
      ...consultation,
      consultationType: type
    });

    if (success) {
      res.status(200).json({ success: true, message: '알림이 발송되었습니다.' });
    } else {
      res.status(500).json({ success: false, message: '알림 발송에 실패했습니다.' });
    }
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}
```

---

## 🔒 보안 고려사항

### 1. 환경 변수 보호
- `.env.local`에 슬랙 웹훅 URL 저장
- 프로덕션에서는 환경 변수로 주입
- Git에 웹훅 URL이 노출되지 않도록 주의

### 2. 개인정보 처리
```typescript
// 민감 정보 마스킹 함수
function maskSensitiveData(data: SlackNotificationData): SlackNotificationData {
  return {
    ...data,
    email: maskEmail(data.email),
    phone: maskPhone(data.phone)
  };
}

function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  const maskedLocal = local.charAt(0) + '*'.repeat(local.length - 2) + local.charAt(local.length - 1);
  return `${maskedLocal}@${domain}`;
}

function maskPhone(phone: string): string {
  return phone.replace(/(\d{3})-(\d{4})-(\d{4})/, '$1-****-$3');
}
```

### 3. 에러 처리
- 슬랙 알림 실패 시에도 상담신청은 정상 처리
- 재시도 메커니즘 구현
- 실패 로그 기록

---

## 📊 모니터링 및 분석

### 1. 알림 발송 로그 테이블

```sql
CREATE TABLE notification_logs (
  id SERIAL PRIMARY KEY,
  consultation_id VARCHAR(50) REFERENCES consultations(id),
  notification_type VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL, -- 'sent', 'failed', 'retrying'
  error_message TEXT,
  sent_at TIMESTAMP,
  retry_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 대시보드 메트릭
- 일일 알림 발송 수
- 알림 발송 성공률
- 평균 발송 시간
- 재시도 현황

---

## 🚀 구현 단계

### Phase 1: 기본 알림 시스템 (1-2일)
1. ✅ 슬랙 웹훅 설정
2. ✅ 기본 알림 유틸리티 구현
3. ✅ 상담신청 API에 알림 연동
4. ✅ 기본 메시지 템플릿 작성

### Phase 2: 고급 기능 (2-3일)
1. ✅ 알림 큐 시스템 구현
2. ✅ 재시도 메커니즘 추가
3. ✅ 관리자 페이지 수동 발송 기능
4. ✅ 에러 알림 시스템

### Phase 3: 모니터링 및 최적화 (1-2일)
1. ✅ 알림 로그 시스템
2. ✅ 대시보드 메트릭 추가
3. ✅ 성능 최적화
4. ✅ 문서화 및 테스트

---

## 🧪 테스트 계획

### 1. 단위 테스트
- 슬랙 메시지 생성 함수
- 데이터 마스킹 함수
- API 엔드포인트

### 2. 통합 테스트
- 상담신청 → 슬랙 알림 전체 플로우
- 에러 시나리오 테스트
- 재시도 메커니즘 테스트

### 3. 성능 테스트
- 동시 다발적 상담신청 처리
- 슬랙 API 응답 시간 측정
- 큐 처리 성능 테스트

---

## 📚 설정 가이드

### 1. 슬랙 웹훅 생성
1. Slack 워크스페이스에서 Apps → Incoming Webhooks 활성화
2. 채널 선택 및 웹훅 URL 생성
3. 환경 변수에 URL 추가

### 2. 환경 변수 설정
```env
# .env.local
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX
SLACK_CHANNEL=#상담신청
SLACK_USERNAME=상담알림봇
SLACK_ICON_EMOJI=:bell:
```

### 3. 패키지 설치
```bash
npm install @slack/webhook node-cron
npm install -D @types/node-cron
```

---

## 🔮 향후 확장 계획

### 1. 다채널 알림
- 이메일 알림 추가
- SMS 알림 연동
- Discord/Teams 연동

### 2. 지능형 알림
- 상담 우선순위에 따른 알림 레벨 조정
- 업무시간 외 알림 스케줄링
- 담당자별 알림 라우팅

### 3. 분석 및 리포팅
- 슬랙 상호작용 분석
- 응답 시간 측정
- A/B 테스트를 통한 메시지 최적화

---

## 📞 문의 및 지원

이 설계서에 대한 질문이나 구현 중 문제가 발생하면 개발팀에 문의해주세요.

**작성일**: 2024년 9월 21일
**버전**: 1.0
**작성자**: Claude AI Assistant